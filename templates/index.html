<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Racing Value Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-card-hover: #21262d;
            --bg-surface: #0d1117;
            --text-primary: #f0f6fc;
            --text-secondary: #c9d1d9;
            --text-muted: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
            --accent-orange: #db6d28;
            --border-color: #30363d;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.5);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        .navbar {
            background: var(--bg-surface) !important;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .navbar-brand i {
            -webkit-text-fill-color: var(--accent-yellow);
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(88, 166, 255, 0.5);
        }
        
        .card-header {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(163, 113, 247, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
            font-weight: 700;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .card-header i {
            opacity: 1;
        }
        
        .card-body {
            padding: 1.25rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 2rem 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .stat-card.success::before {
            background: var(--gradient-success);
        }
        
        .stat-card.warning::before {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, var(--accent-orange) 100%);
        }
        
        .stat-card.danger::before {
            background: var(--gradient-warning);
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .value-pick {
            background: var(--bg-surface);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--accent-green);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .value-pick:hover {
            background: var(--bg-card-hover);
            transform: translateX(4px);
        }
        
        .dud-alert {
            border-left-color: var(--accent-red);
        }
        
        .arb-card {
            border-left-color: var(--accent-yellow);
            position: relative;
        }
        
        .arb-card.active {
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(210, 153, 34, 0.3),
                            0 0 10px rgba(210, 153, 34, 0.2);
            }
            50% { 
                box-shadow: 0 0 15px rgba(210, 153, 34, 0.5),
                            0 0 25px rgba(210, 153, 34, 0.3);
            }
        }
        
        .edge-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            gap: 0.25rem;
        }
        
        .edge-positive {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(63, 185, 80, 0.3);
        }
        
        .edge-negative {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(248, 81, 73, 0.3);
        }
        
        .odds-badge {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            color: white;
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            display: inline-block;
        }
        
        .star-rating {
            color: var(--accent-yellow);
            letter-spacing: 2px;
        }
        
        .btn {
            border-radius: 10px;
            font-weight: 600;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--accent-blue);
            border: none;
        }
        
        .btn-primary:hover {
            background: #4393eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
        }
        
        .btn-success {
            background: var(--accent-green);
            border: none;
        }
        
        .btn-success:hover {
            background: #2ea043;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--accent-yellow);
            border: none;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #e5a722;
            transform: translateY(-2px);
        }
        
        .btn-outline-light {
            border-color: var(--border-color);
            color: var(--text-secondary);
        }
        
        .btn-outline-light:hover {
            background: var(--bg-card);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        .form-control, .form-select {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 0.65rem 1rem;
            transition: all 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus {
            background: var(--bg-card);
            border-color: var(--accent-blue);
            color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .table {
            color: var(--text-primary);
        }
        
        .table thead th {
            border-bottom: 2px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1px;
            padding: 1rem 0.75rem;
        }
        
        .table td {
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            padding: 0.875rem 0.75rem;
        }
        
        .table tbody tr {
            transition: background 0.2s ease;
        }
        
        .table tbody tr:hover {
            background: var(--bg-surface);
        }
        
        .horse-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .bookmaker-tag {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--bg-surface);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }
        
        .nav-pills .nav-link {
            color: var(--text-secondary);
            border-radius: 10px;
            padding: 0.5rem 1rem;
        }
        
        .nav-pills .nav-link.active {
            background: var(--accent-blue);
            color: white;
        }
        
        .progress {
            height: 6px;
            background: var(--bg-surface);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar {
            border-radius: 3px;
            background: var(--gradient-primary);
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }
        
        .modal-title {
            font-weight: 700;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .loading .loading-spinner {
            display: inline-block;
        }
        
        .refresh-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .refresh-time i {
            color: var(--accent-green);
        }
        
        .monitoring-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent-green);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(63, 185, 80, 0.4);
        }
        
        .dutch-result {
            background: var(--bg-surface);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
        }
        
        .stake-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .stake-row:last-child {
            border-bottom: none;
        }
        
        .profit-positive {
            color: var(--accent-green);
            font-weight: 600;
        }
        
        .profit-negative {
            color: var(--accent-red);
            font-weight: 600;
        }
        
        .venue-header {
            background: var(--gradient-primary);
            padding: 0.625rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        #toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }
        
        .toast-header {
            border-radius: 12px 12px 0 0;
        }
        
        .form-check-input {
            background-color: var(--bg-surface);
            border-color: var(--border-color);
        }
        
        .form-check-input:checked {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .form-check-input:focus {
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }
        
        .badge {
            font-weight: 600;
            padding: 0.4em 0.8em;
            border-radius: 6px;
        }
        
        /* Hero section for empty states */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            background: rgba(48, 54, 61, 0.3);
            border-radius: 12px;
            border: 1px dashed var(--border-color);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--accent-blue);
            opacity: 0.7;
        }
        
        .empty-state p {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .empty-state small {
            color: var(--text-secondary);
        }
        
        /* Scraping Status Banner */
        .scraping-banner {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            animation: pulse 2s infinite;
        }
        
        .scraping-banner.hidden {
            display: none;
        }
        
        .scraping-progress {
            flex: 1;
            max-width: 300px;
        }
        
        .scraping-progress .progress {
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .scraping-progress .progress-bar {
            background: white;
            transition: width 0.5s ease;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .value-pick, .card {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- Scraping Status Banner -->
    <div id="scrapingBanner" class="scraping-banner hidden">
        <div class="d-flex align-items-center gap-3">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <div>
                <strong id="scrapingStep">Scraping data...</strong>
                <div class="small opacity-75" id="scrapingTime">Estimated time: calculating...</div>
            </div>
        </div>
        <div class="scraping-progress">
            <div class="progress">
                <div class="progress-bar" id="scrapingProgressBar" style="width: 0%"></div>
            </div>
            <div class="text-end small mt-1" id="scrapingPercent">0%</div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#">
                <i class="bi bi-trophy-fill"></i>
                Racing Value Finder
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="refresh-time">
                    <i class="bi bi-broadcast-pin"></i>
                    <span>Updated: <strong id="lastUpdated">--:--:--</strong></span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="refreshData()" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 py-4">
        <!-- Stats Row -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card">
                    <div class="stat-value" id="totalRaces">0</div>
                    <div class="stat-label">Races Analyzed</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card success">
                    <div class="stat-value" id="valuePicks">0</div>
                    <div class="stat-label">Value Picks</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card warning">
                    <div class="stat-value" id="arbCount">0</div>
                    <div class="stat-label">Market Edges</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card danger">
                    <div class="stat-value" id="dudCount">0</div>
                    <div class="stat-label">Dud Favourites</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row g-4">
            <!-- Left Column - Value Picks & Duds -->
            <div class="col-xl-6">
                <!-- Value Picks -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-gem me-2" style="color: var(--accent-green);"></i>Value Picks</span>
                        <span class="badge bg-success" id="valuePicksBadge">0</span>
                    </div>
                    <div class="card-body" id="valuePicksContainer" style="max-height: 450px; overflow-y: auto;">
                        <div class="empty-state">
                            <i class="bi bi-hourglass-split"></i>
                            <p>Loading value picks...</p>
                        </div>
                    </div>
                </div>

                <!-- Dud Favourites / Dutch The Field -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-exclamation-triangle me-2" style="color: var(--accent-red);"></i>Dud Favourites - Dutch The Field</span>
                        <span class="badge bg-danger" id="dudBadge">0</span>
                    </div>
                    <div class="card-body p-2" style="font-size: 0.75rem; color: var(--text-muted); border-bottom: 1px solid var(--border-color);">
                        <i class="bi bi-info-circle me-1"></i>When a favourite is overrated, dutch bet the rest of the field for value
                    </div>
                    <div class="card-body" id="dudContainer" style="max-height: 500px; overflow-y: auto;">
                        <div class="empty-state">
                            <i class="bi bi-hourglass-split"></i>
                            <p>Loading alerts...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Market Edges & Dutch Calculator -->
            <div class="col-xl-6">
                <!-- Market Edge Opportunities -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-graph-up-arrow me-2" style="color: var(--accent-yellow);"></i>Market Edge Opportunities</span>
                        <span class="badge bg-warning text-dark" id="arbBadge">0</span>
                    </div>
                    <div class="card-body" id="arbContainer" style="max-height: 400px; overflow-y: auto;">
                        <div class="empty-state">
                            <i class="bi bi-hourglass-split"></i>
                            <p>Scanning markets...</p>
                        </div>
                    </div>
                </div>

                <!-- Dutch Calculator -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-calculator me-2" style="color: var(--accent-blue);"></i>Dutching Calculator
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Bankroll ($)</label>
                                <input type="number" class="form-control" id="bankrollInput" value="100" min="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Venue</label>
                                <select class="form-select" id="venueSelect" onchange="updateRaceSelect()">
                                    <option value="">Select venue...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Race</label>
                                <select class="form-select" id="raceSelect" onchange="loadRaceForDutch()">
                                    <option value="">Select race...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="dutchHorsesContainer" class="mb-3" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-secondary text-center py-3">Select a race to see horses</p>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="calculateDutch()">
                            <i class="bi bi-calculator me-2"></i>Calculate Stakes
                        </button>
                        
                        <div id="dutchResultContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Races Table -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-list-columns me-2"></i>All Races</span>
                        <small class="text-muted">Click a row to view details</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="racesTable">
                                <thead>
                                    <tr>
                                        <th>Venue</th>
                                        <th>Race</th>
                                        <th>Field</th>
                                        <th>Overround</th>
                                        <th>Top Pick</th>
                                        <th>Favourite</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="racesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Race Detail Modal -->
    <div class="modal fade" id="raceModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="raceModalTitle">Race Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="raceModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="dutchFromModal()">
                        <i class="bi bi-calculator me-2"></i>Dutch Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let appData = {
            races: [],
            odds: [],
            value_picks: [],
            arb_opportunities: [],
            dud_favourites: []
        };
        
        let currentRace = null;
        let socket = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initSocket();
            checkScrapeStatus(); // Check if scraping is in progress on load
        });
        
        function initSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });
            
            socket.on('arb_update', function(data) {
                updateArbOpportunity(data);
                showToast('Market Update', `${data.venue} R${data.race_number}: ${data.status}`, 
                    data.status === 'active' ? 'success' : 'warning');
            });
            
            socket.on('data_refreshed', function(data) {
                showToast('Data Updated', 'Fresh race data loaded', 'success');
                loadData();
            });
            
            // Listen for real-time scrape progress updates
            socket.on('scrape_progress', function(status) {
                updateScrapeUI(status);
            });
        }
        
        function updateScrapeUI(status) {
            const banner = document.getElementById('scrapingBanner');
            const refreshBtn = document.getElementById('refreshBtn');
            
            if (status.is_scraping) {
                banner.classList.remove('hidden');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Scraping...';
                
                document.getElementById('scrapingStep').textContent = status.current_step || 'Scraping data...';
                document.getElementById('scrapingTime').textContent = status.estimated_time_remaining 
                    ? `Estimated time remaining: ${status.estimated_time_remaining}` 
                    : 'Please wait...';
                document.getElementById('scrapingProgressBar').style.width = `${status.progress || 0}%`;
                document.getElementById('scrapingPercent').textContent = `${status.progress || 0}%`;
            } else {
                banner.classList.add('hidden');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i> Refresh';
            }
        }
        
        async function loadData() {
            try {
                const response = await fetch('/api/data');
                appData = await response.json();
                
                document.getElementById('lastUpdated').textContent = appData.last_updated || '--:--:--';
                document.getElementById('totalRaces').textContent = appData.total_races || 0;
                document.getElementById('valuePicks').textContent = appData.value_picks?.length || 0;
                document.getElementById('arbCount').textContent = appData.arb_opportunities?.length || 0;
                document.getElementById('dudCount').textContent = appData.dud_favourites?.length || 0;
                
                document.getElementById('valuePicksBadge').textContent = appData.value_picks?.length || 0;
                document.getElementById('arbBadge').textContent = appData.arb_opportunities?.length || 0;
                document.getElementById('dudBadge').textContent = appData.dud_favourites?.length || 0;
                
                renderValuePicks();
                renderDudFavourites();
                renderArbOpportunities();
                renderRacesTable();
                populateVenueSelect();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error', 'Failed to load data', 'danger');
            }
        }
        
        // Check scraping status (called on page load and after starting scrape)
        async function checkScrapeStatus() {
            try {
                const response = await fetch('/api/scrape_status');
                const status = await response.json();
                updateScrapeUI(status);
            } catch (error) {
                console.error('Error checking scrape status:', error);
            }
        }
        
        async function refreshData() {
            showToast('Refreshing', 'Starting data scrape...', 'info');
            try {
                await fetch('/api/scrape_now', { method: 'POST' });
                // Initial status check - WebSocket will handle real-time updates
                setTimeout(checkScrapeStatus, 500);
            } catch (error) {
                showToast('Error', 'Failed to start scrape', 'danger');
            }
        }
        
        function renderValuePicks() {
            const container = document.getElementById('valuePicksContainer');
            
            if (!appData.value_picks || appData.value_picks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-search"></i>
                        <p>No value picks found today</p>
                        <small>Check back when more races are analyzed</small>
                    </div>`;
                return;
            }
            
            let html = '';
            appData.value_picks.forEach((pick, index) => {
                const stars = '★'.repeat(pick.value_rating) + '☆'.repeat(5 - pick.value_rating);
                const delay = index * 50;
                html += `
                    <div class="value-pick" onclick="viewRace('${pick.venue}', ${pick.race_number})" style="animation-delay: ${delay}ms;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="badge bg-secondary" style="font-size: 0.7rem;">${pick.venue}</span>
                                    <span class="text-muted" style="font-size: 0.8rem;">Race ${pick.race_number}</span>
                                </div>
                                <h6 class="horse-name mb-2">${pick.horse}</h6>
                                <span class="bookmaker-tag"><i class="bi bi-shop me-1"></i>${pick.best_at}</span>
                            </div>
                            <div class="text-end">
                                <span class="odds-badge">$${pick.best_odds.toFixed(2)}</span>
                                <div class="mt-2">
                                    <span class="edge-badge edge-positive">
                                        <i class="bi bi-arrow-up-short"></i>+${(pick.edge * 100).toFixed(1)}%
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 pt-2 d-flex justify-content-between align-items-center" style="border-top: 1px solid var(--border-color);">
                            <div class="d-flex gap-3">
                                <small class="text-muted"><i class="bi bi-bullseye me-1"></i>Fair: $${pick.fair_odds}</small>
                                <small class="text-muted"><i class="bi bi-percent me-1"></i>Win: ${(pick.model_prob * 100).toFixed(0)}%</small>
                            </div>
                            <span class="star-rating">${stars}</span>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function renderDudFavourites() {
            const container = document.getElementById('dudContainer');
            
            if (!appData.dud_favourites || appData.dud_favourites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-shield-check"></i>
                        <p>No dud favourites detected</p>
                        <small>All favourites look solid today</small>
                    </div>`;
                return;
            }
            
            let html = '';
            appData.dud_favourites.forEach((dud, index) => {
                const delay = index * 50;
                const isDutchArb = dud.is_dutch_arb;
                const fieldEdgeClass = dud.field_edge > 0 ? 'edge-positive' : 'edge-negative';
                
                // Build dutch stakes table
                let dutchStakesHtml = '';
                if (dud.dutch_stakes && dud.dutch_stakes.length > 0) {
                    dutchStakesHtml = `
                        <div class="mt-3 pt-3" style="border-top: 1px solid var(--border-color);">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong style="color: var(--accent-purple); font-size: 0.85rem;">
                                    <i class="bi bi-calculator me-1"></i>Dutch The Field Strategy
                                </strong>
                                ${isDutchArb ? '<span class="badge" style="background: linear-gradient(135deg, var(--accent-green), #2ea043); font-size: 0.65rem;">GUARANTEED PROFIT</span>' : ''}
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-4">
                                    <div class="text-center p-2" style="background: var(--bg-surface); border-radius: 8px;">
                                        <div style="font-size: 0.65rem; color: var(--text-muted);">Field Win %</div>
                                        <div style="font-size: 1rem; font-weight: 700; color: var(--accent-green);">${dud.field_model_prob}%</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-center p-2" style="background: var(--bg-surface); border-radius: 8px;">
                                        <div style="font-size: 0.65rem; color: var(--text-muted);">Dutch Book</div>
                                        <div style="font-size: 1rem; font-weight: 700; ${dud.field_dutch_book < 1 ? 'color: var(--accent-green);' : ''}">${dud.field_dutch_book.toFixed(3)}</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-center p-2" style="background: var(--bg-surface); border-radius: 8px;">
                                        <div style="font-size: 0.65rem; color: var(--text-muted);">Edge</div>
                                        <div style="font-size: 1rem; font-weight: 700; ${dud.field_edge > 0 ? 'color: var(--accent-green);' : 'color: var(--text-muted);'}">+${dud.field_edge}%</div>
                                    </div>
                                </div>
                            </div>
                            ${isDutchArb ? `<div class="alert mb-2" style="background: rgba(46, 160, 67, 0.15); border: 1px solid var(--accent-green); border-radius: 8px; padding: 0.5rem; font-size: 0.75rem; color: var(--accent-green);">
                                <i class="bi bi-check-circle-fill me-1"></i>Dutch profit: <strong>${dud.dutch_profit_pct.toFixed(2)}%</strong> guaranteed if any non-favourite wins
                            </div>` : ''}
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Stakes to return $100:</div>
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm mb-0" style="font-size: 0.75rem;">
                                    <thead style="position: sticky; top: 0; background: var(--bg-card);">
                                        <tr>
                                            <th style="padding: 0.3rem;">Horse</th>
                                            <th style="padding: 0.3rem;">Odds</th>
                                            <th style="padding: 0.3rem;">Stake %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dud.dutch_stakes.slice(0, 8).map(h => `
                                            <tr>
                                                <td style="padding: 0.3rem;"><span class="text-muted">${h.number}.</span> ${h.name}</td>
                                                <td style="padding: 0.3rem;">$${h.odds.toFixed(2)}</td>
                                                <td style="padding: 0.3rem; color: var(--accent-blue); font-weight: 600;">${h.stake_pct}%</td>
                                            </tr>
                                        `).join('')}
                                        ${dud.dutch_stakes.length > 8 ? `<tr><td colspan="3" class="text-muted text-center">+${dud.dutch_stakes.length - 8} more...</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                }
                
                html += `
                    <div class="value-pick dud-alert" onclick="viewRace('${dud.venue}', ${dud.race_number})" style="animation-delay: ${delay}ms; cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="badge bg-secondary" style="font-size: 0.7rem;">${dud.venue}</span>
                                    <span class="text-muted" style="font-size: 0.8rem;">Race ${dud.race_number}</span>
                                    ${dud.field_size ? `<span class="text-muted" style="font-size: 0.7rem;">(${dud.field_size + 1} runners)</span>` : ''}
                                </div>
                                <h6 class="horse-name mb-1" style="color: var(--accent-red);">
                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>${dud.favourite}
                                </h6>
                                <span class="bookmaker-tag">Favourite @ $${dud.odds.toFixed(2)}</span>
                            </div>
                            <div class="text-end">
                                <span class="edge-badge edge-negative">
                                    ${dud.overrated_by || Math.abs(dud.edge * 100).toFixed(1)}% overrated
                                </span>
                            </div>
                        </div>
                        <div class="mt-3 pt-2" style="border-top: 1px solid var(--border-color);">
                            <div class="d-flex gap-3 mb-2">
                                <small class="text-muted"><i class="bi bi-cpu me-1"></i>Model: ${(dud.model_prob * 100).toFixed(0)}%</small>
                                <small class="text-muted"><i class="bi bi-graph-up me-1"></i>Market: ${(dud.implied_prob * 100).toFixed(0)}%</small>
                            </div>
                            <small style="color: var(--accent-green);"><i class="bi bi-lightbulb me-1"></i>Better picks: ${dud.better_picks.join(', ')}</small>
                        </div>
                        ${dutchStakesHtml}
                    </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function renderArbOpportunities() {
            const container = document.getElementById('arbContainer');
            
            if (!appData.arb_opportunities || appData.arb_opportunities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-graph-up-arrow"></i>
                        <p>No market edges found</p>
                        <small>Markets are efficient - keep checking!</small>
                    </div>`;
                return;
            }
            
            let html = '';
            appData.arb_opportunities.forEach((arb, index) => {
                const statusClass = arb.status === 'active' ? 'active' : '';
                const delay = index * 50;
                html += `
                    <div class="value-pick arb-card ${statusClass}" id="arb-${arb.venue}-${arb.race_number}" style="animation-delay: ${delay}ms;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="badge bg-secondary" style="font-size: 0.7rem;">${arb.venue}</span>
                                    <span class="text-muted" style="font-size: 0.8rem;">Race ${arb.race_number}</span>
                                </div>
                                <h6 class="mb-2" style="color: var(--accent-yellow);">
                                    <i class="bi bi-lightning-charge-fill me-1"></i>
                                    ${arb.guaranteed_profit_pct.toFixed(2)}% Edge
                                </h6>
                                <span class="bookmaker-tag"><i class="bi bi-people me-1"></i>${arb.field_size} runners</span>
                            </div>
                            <div class="text-end">
                                <span class="badge ${arb.status === 'active' ? 'bg-success' : 'bg-secondary'}" style="text-transform: capitalize;">
                                    ${arb.status}
                                </span>
                            </div>
                        </div>
                        <div class="mt-3 pt-2 d-flex justify-content-between align-items-center" style="border-top: 1px solid var(--border-color);">
                            <small class="text-muted"><i class="bi bi-book me-1"></i>Book: ${arb.dutch_book.toFixed(4)}</small>
                            <small class="text-muted"><i class="bi bi-clock me-1"></i>${arb.last_checked}</small>
                        </div>
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-sm btn-primary flex-grow-1" 
                                onclick="event.stopPropagation(); viewRace('${arb.venue}', ${arb.race_number})">
                                <i class="bi bi-eye me-1"></i>View
                            </button>
                            <button class="btn btn-sm btn-warning flex-grow-1"
                                onclick="event.stopPropagation(); startArbMonitor('${arb.venue}', ${arb.race_number}, '${arb.url}')">
                                <i class="bi bi-broadcast me-1"></i>Monitor
                            </button>
                            <button class="btn btn-sm btn-success flex-grow-1"
                                onclick="event.stopPropagation(); dutchArb('${arb.venue}', ${arb.race_number})">
                                <i class="bi bi-calculator me-1"></i>Dutch
                            </button>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function renderRacesTable() {
            const tbody = document.getElementById('racesTableBody');
            
            if (!appData.odds || appData.odds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No races loaded</td></tr>';
                return;
            }
            
            // Group by venue
            const venues = {};
            appData.odds.forEach(race => {
                if (!venues[race.venue]) venues[race.venue] = [];
                venues[race.venue].push(race);
            });
            
            let html = '';
            Object.entries(venues).forEach(([venue, races]) => {
                races.sort((a, b) => a.race_number - b.race_number);
                races.forEach(race => {
                    const horses = race.horses || [];
                    const validHorses = horses.filter(h => h.best_odds && h.best_odds < 500);
                    const dutchBook = validHorses.reduce((sum, h) => sum + (1 / h.best_odds), 0);
                    const overround = ((dutchBook - 1) * 100).toFixed(1);
                    
                    // Get favourite
                    const favourite = validHorses.reduce((fav, h) => 
                        (!fav || h.best_odds < fav.best_odds) ? h : fav, null);
                    
                    // Find form data for top pick
                    let topPick = '-';
                    const formRace = appData.races.find(r => 
                        r.venue.toLowerCase() === venue.toLowerCase() && r.race_number === race.race_number);
                    if (formRace && formRace.horses && formRace.horses.length > 0) {
                        const sorted = [...formRace.horses].sort((a, b) => (b.form_score || 0) - (a.form_score || 0));
                        topPick = sorted[0]?.name || '-';
                    }
                    
                    const hasEdge = dutchBook < 1;
                    
                    html += `
                        <tr onclick="viewRace('${venue}', ${race.race_number})" style="cursor: pointer;">
                            <td>
                                <span class="fw-semibold">${venue}</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">R${race.race_number}</span>
                            </td>
                            <td>${validHorses.length}</td>
                            <td>
                                <span class="${hasEdge ? 'profit-positive' : 'text-muted'}">${overround}%</span>
                                ${hasEdge ? '<i class="bi bi-lightning-charge-fill ms-1" style="color: var(--accent-yellow);"></i>' : ''}
                            </td>
                            <td class="text-truncate" style="max-width: 120px;">${topPick}</td>
                            <td>
                                ${favourite ? `
                                    <span class="text-truncate d-inline-block" style="max-width: 100px; vertical-align: middle;">${favourite.name}</span>
                                    <span class="odds-badge ms-1">$${favourite.best_odds.toFixed(2)}</span>
                                ` : '<span class="text-muted">-</span>'}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewRace('${venue}', ${race.race_number})">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            });
            
            tbody.innerHTML = html;
        }
        
        function populateVenueSelect() {
            const select = document.getElementById('venueSelect');
            const venues = [...new Set(appData.odds.map(r => r.venue))].sort();
            
            select.innerHTML = '<option value="">Select venue...</option>';
            venues.forEach(v => {
                select.innerHTML += `<option value="${v}">${v}</option>`;
            });
        }
        
        function updateRaceSelect() {
            const venue = document.getElementById('venueSelect').value;
            const select = document.getElementById('raceSelect');
            
            select.innerHTML = '<option value="">Select race...</option>';
            document.getElementById('dutchHorsesContainer').innerHTML = 
                '<p class="text-secondary text-center">Select a race to see horses</p>';
            
            if (!venue) return;
            
            const races = appData.odds.filter(r => r.venue === venue).sort((a, b) => a.race_number - b.race_number);
            races.forEach(r => {
                select.innerHTML += `<option value="${r.race_number}">Race ${r.race_number}</option>`;
            });
        }
        
        async function loadRaceForDutch() {
            const venue = document.getElementById('venueSelect').value;
            const raceNum = parseInt(document.getElementById('raceSelect').value);
            
            if (!venue || !raceNum) return;
            
            try {
                const response = await fetch(`/api/race/${encodeURIComponent(venue)}/${raceNum}`);
                const race = await response.json();
                
                currentRace = race;
                
                let html = '';
                race.horses.forEach(h => {
                    if (!h.best_odds || h.best_odds >= 500) return;
                    html += `
                        <div class="form-check stake-row">
                            <input class="form-check-input dutch-horse" type="checkbox" 
                                value="${h.name}" id="dutch-${h.number}" checked>
                            <label class="form-check-label flex-grow-1" for="dutch-${h.number}">
                                <strong>${h.number}. ${h.name}</strong>
                                <small class="text-secondary ms-2">$${h.best_odds}</small>
                            </label>
                            <span class="badge bg-secondary">${(h.model_prob * 100).toFixed(0)}%</span>
                        </div>`;
                });
                
                document.getElementById('dutchHorsesContainer').innerHTML = html || 
                    '<p class="text-secondary text-center">No horses with valid odds</p>';
                
            } catch (error) {
                console.error('Error loading race:', error);
            }
        }
        
        async function calculateDutch() {
            const venue = document.getElementById('venueSelect').value;
            const raceNum = parseInt(document.getElementById('raceSelect').value);
            const bankroll = parseFloat(document.getElementById('bankrollInput').value) || 100;
            
            if (!venue || !raceNum) {
                showToast('Error', 'Please select a venue and race', 'warning');
                return;
            }
            
            // Get selected horses
            const selectedHorses = [];
            document.querySelectorAll('.dutch-horse:checked').forEach(cb => {
                selectedHorses.push(cb.value);
            });
            
            try {
                const response = await fetch('/api/calculate_dutch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        venue: venue,
                        race_number: raceNum,
                        bankroll: bankroll,
                        horses: selectedHorses
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showToast('Error', result.error, 'danger');
                    return;
                }
                
                renderDutchResult(result);
                
            } catch (error) {
                console.error('Error calculating dutch:', error);
                showToast('Error', 'Failed to calculate', 'danger');
            }
        }
        
        function renderDutchResult(result) {
            const container = document.getElementById('dutchResultContainer');
            
            let stakesHtml = '';
            result.stakes.forEach(s => {
                stakesHtml += `
                    <div class="stake-row">
                        <div>
                            <strong>${s.name}</strong>
                            <small class="text-muted ms-2">@ $${s.odds.toFixed(2)}</small>
                            <span class="bookmaker-tag d-block mt-1"><i class="bi bi-shop me-1"></i>${s.bookmaker}</span>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">$${s.stake.toFixed(2)}</div>
                            <small class="${s.profit_if_wins >= 0 ? 'profit-positive' : 'profit-negative'}">
                                ${s.profit_if_wins >= 0 ? '+' : ''}$${s.profit_if_wins.toFixed(2)}
                            </small>
                        </div>
                    </div>`;
            });
            
            container.innerHTML = `
                <div class="dutch-result">
                    <div class="d-flex justify-content-between align-items-start mb-3 pb-3" style="border-bottom: 1px solid var(--border-color);">
                        <div>
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <span class="badge bg-secondary">${result.venue}</span>
                                <span class="text-muted">Race ${result.race_number}</span>
                            </div>
                            <small class="text-muted"><i class="bi bi-wallet2 me-1"></i>Bankroll: $${result.bankroll}</small>
                        </div>
                        <div class="text-end">
                            ${result.is_arb ? 
                                `<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>EDGE FOUND</span>
                                 <div class="profit-positive mt-1">
                                    <i class="bi bi-plus-circle me-1"></i>$${result.guaranteed_profit.toFixed(2)} profit
                                 </div>` :
                                `<span class="badge bg-secondary">Overround: ${result.overround_pct}%</span>`
                            }
                        </div>
                    </div>
                    
                    <div class="d-flex gap-4 mb-3">
                        <div>
                            <small class="text-muted d-block">Dutch Book</small>
                            <span class="fw-semibold">${result.dutch_book.toFixed(4)}</span>
                        </div>
                        <div>
                            <small class="text-muted d-block">Expected ROI</small>
                            <span class="${result.roi >= 0 ? 'profit-positive' : 'profit-negative'} fw-semibold">
                                ${result.roi >= 0 ? '+' : ''}${result.roi.toFixed(1)}%
                            </span>
                        </div>
                    </div>
                    
                    <h6 class="text-muted mb-3" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">
                        <i class="bi bi-list-check me-1"></i>Recommended Stakes
                    </h6>
                    ${stakesHtml}
                    
                    <div class="mt-3 pt-3 text-end" style="border-top: 1px solid var(--border-color);">
                        <span class="text-muted me-2">Total Investment:</span>
                        <strong class="fs-5">$${result.total_stake.toFixed(2)}</strong>
                    </div>
                </div>`;
        }
        
        async function viewRace(venue, raceNum) {
            try {
                const response = await fetch(`/api/race/${encodeURIComponent(venue)}/${raceNum}`);
                const race = await response.json();
                
                currentRace = race;
                
                document.getElementById('raceModalTitle').innerHTML = `
                    <i class="bi bi-flag-fill me-2" style="color: var(--accent-blue);"></i>
                    ${venue} - Race ${raceNum}${race.race_name ? ': ' + race.race_name : ''}
                `;
                
                let tableHtml = `
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <span class="badge bg-primary"><i class="bi bi-people me-1"></i>Field: ${race.field_size}</span>
                        <span class="badge ${race.is_arb ? 'bg-success' : 'bg-secondary'}">
                            <i class="bi bi-percent me-1"></i>Overround: ${race.overround_pct}%
                        </span>
                        ${race.is_arb ? '<span class="badge bg-warning text-dark"><i class="bi bi-lightning-charge me-1"></i>EDGE FOUND</span>' : ''}
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="selectAll" 
                                        onchange="toggleAllHorses(this)" checked></th>
                                    <th style="width: 50px;">#</th>
                                    <th>Horse</th>
                                    <th style="width: 80px;">Form</th>
                                    <th style="width: 80px;">Model %</th>
                                    <th style="width: 100px;">Best Odds</th>
                                    <th style="width: 100px;">Bookmaker</th>
                                    <th style="width: 80px;">Edge</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                race.horses.forEach(h => {
                    if (!h.best_odds || h.best_odds >= 500) return;
                    
                    const implied = 1 / h.best_odds;
                    const edge = h.model_prob - implied;
                    const edgeClass = edge > 0.02 ? 'edge-positive' : (edge < -0.02 ? 'edge-negative' : '');
                    
                    tableHtml += `
                        <tr>
                            <td><input type="checkbox" class="form-check-input modal-horse" 
                                value="${h.name}" checked></td>
                            <td><span class="badge bg-secondary">${h.number}</span></td>
                            <td>
                                <strong class="d-block">${h.name}</strong>
                                ${h.jockey ? `<small class="text-muted"><i class="bi bi-person me-1"></i>${h.jockey}</small>` : ''}
                            </td>
                            <td><code style="background: var(--bg-surface); padding: 0.25rem 0.5rem; border-radius: 4px;">${h.form || '-'}</code></td>
                            <td><span class="fw-semibold">${(h.model_prob * 100).toFixed(1)}%</span></td>
                            <td><span class="odds-badge">$${h.best_odds.toFixed(2)}</span></td>
                            <td><span class="bookmaker-tag">${h.best_bookmaker}</span></td>
                            <td><span class="edge-badge ${edgeClass}">${edge >= 0 ? '+' : ''}${(edge * 100).toFixed(1)}%</span></td>
                        </tr>`;
                });
                
                tableHtml += '</tbody></table></div>';
                
                document.getElementById('raceModalBody').innerHTML = tableHtml;
                
                new bootstrap.Modal(document.getElementById('raceModal')).show();
                
            } catch (error) {
                console.error('Error loading race:', error);
                showToast('Error', 'Failed to load race details', 'danger');
            }
        }
        
        function toggleAllHorses(cb) {
            document.querySelectorAll('.modal-horse').forEach(h => h.checked = cb.checked);
        }
        
        async function dutchFromModal() {
            if (!currentRace) return;
            
            const bankroll = parseFloat(document.getElementById('bankrollInput').value) || 100;
            const selectedHorses = [];
            document.querySelectorAll('.modal-horse:checked').forEach(cb => {
                selectedHorses.push(cb.value);
            });
            
            try {
                const response = await fetch('/api/calculate_dutch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        venue: currentRace.venue,
                        race_number: currentRace.race_number,
                        bankroll: bankroll,
                        horses: selectedHorses
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    showToast('Error', result.error, 'danger');
                    return;
                }
                
                // Close modal and show result in calculator
                bootstrap.Modal.getInstance(document.getElementById('raceModal')).hide();
                
                document.getElementById('venueSelect').value = currentRace.venue;
                updateRaceSelect();
                document.getElementById('raceSelect').value = currentRace.race_number;
                
                renderDutchResult(result);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error', 'Failed to calculate', 'danger');
            }
        }
        
        async function dutchArb(venue, raceNum) {
            document.getElementById('venueSelect').value = venue;
            updateRaceSelect();
            setTimeout(() => {
                document.getElementById('raceSelect').value = raceNum;
                loadRaceForDutch();
                setTimeout(() => calculateDutch(), 500);
            }, 100);
        }
        
        async function startArbMonitor(venue, raceNum, url) {
            try {
                const response = await fetch('/api/start_arb_monitor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        venue: venue,
                        race_number: raceNum,
                        url: url
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'started') {
                    showToast('Monitoring', `Now monitoring ${venue} R${raceNum} (every 2 min)`, 'success');
                    
                    // Add monitoring badge
                    const card = document.getElementById(`arb-${venue}-${raceNum}`);
                    if (card && !card.querySelector('.monitoring-badge')) {
                        card.insertAdjacentHTML('afterbegin', 
                            '<span class="monitoring-badge"><i class="bi bi-broadcast"></i> Live</span>');
                    }
                } else if (result.status === 'already_monitoring') {
                    showToast('Info', 'Already monitoring this race', 'info');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error', 'Failed to start monitoring', 'danger');
            }
        }
        
        function updateArbOpportunity(arb) {
            const card = document.getElementById(`arb-${arb.venue}-${arb.race_number}`);
            if (!card) return;
            
            // Update status badge
            const statusBadge = card.querySelector('.badge');
            if (statusBadge) {
                statusBadge.className = `badge ${arb.status === 'active' ? 'bg-success' : 'bg-secondary'}`;
                statusBadge.innerHTML = `${arb.status === 'active' ? '<i class="bi bi-check-circle me-1"></i>' : ''}${arb.status}`;
            }
            
            // Update profit
            const profitEl = card.querySelector('h6');
            if (profitEl) {
                profitEl.innerHTML = `
                    <i class="bi bi-lightning-charge-fill me-1"></i>
                    ${arb.guaranteed_profit_pct.toFixed(2)}% Edge`;
            }
            
            // Update timestamp
            const timeEl = card.querySelector('small:last-of-type');
            if (timeEl && timeEl.textContent.includes('Checked:')) {
                timeEl.innerHTML = `<i class="bi bi-clock me-1"></i>${arb.last_checked}`;
            }
            
            // Visual feedback
            card.style.transition = 'all 0.5s ease';
            card.style.background = arb.status === 'active' ? 
                'rgba(63, 185, 80, 0.1)' : 'rgba(248, 81, 73, 0.1)';
            card.style.borderColor = arb.status === 'active' ? 
                'var(--accent-green)' : 'var(--accent-red)';
            setTimeout(() => {
                card.style.background = '';
                card.style.borderColor = '';
            }, 2000);
        }
        
        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toast-container');
            const id = 'toast-' + Date.now();
            
            const config = {
                'success': { bg: 'bg-success', icon: 'bi-check-circle-fill' },
                'danger': { bg: 'bg-danger', icon: 'bi-x-circle-fill' }, 
                'warning': { bg: 'bg-warning', icon: 'bi-exclamation-triangle-fill' },
                'info': { bg: 'bg-primary', icon: 'bi-info-circle-fill' }
            }[type] || { bg: 'bg-primary', icon: 'bi-info-circle-fill' };
            
            container.insertAdjacentHTML('beforeend', `
                <div id="${id}" class="toast" role="alert">
                    <div class="toast-header ${config.bg} text-white">
                        <i class="bi ${config.icon} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>`);
            
            const toastEl = document.getElementById(id);
            const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }
    </script>
</body>
</html>
